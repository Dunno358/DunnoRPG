{% extends 'master.html' %}
{% load filters %}

{% block content %}
{% include 'top_bar.html' %}

<div class="container-fluid">        
    <div class="header-bg bg-dark border-top border-bottom border-warning row p-2">
        <div class='col-1 btn btn-dark btn-outline-primary border border-primary rounded ms-5 me-5'>
            <span class='h5'><</span>
        </div>

        <button id='Stats'  onclick="show_or_hideByName(this)" class='col btn btn-dark btn-outline-warning border border-warning rounded ms-5 me-5'>
            Stats</button>

        <button id='Equipment' onclick="show_or_hideByName(this)" class='col btn btn-dark btn-outline-primary border border-primary rounded ms-5 me-5'>
            Equipment</button>

        <button id='Skills' onclick="show_or_hideByName(this)" class='col btn btn-dark btn-outline-warning border border-warning rounded ms-5 me-5'>
            Skills</button>
        
        <button id='Effects' onclick="show_or_hideByName(this)" class='col btn btn-dark btn-outline-warning border border-warning rounded ms-5 me-5'>
            Effects</button>

        <div class='col-1 btn btn-dark btn-outline-primary border border-primary rounded ms-5 me-5'>
            <span class='h5'>></span>
        </div>
    </div>
</div>

<div class="ms-5 container row">
    {% for value in chosen_character %}

    <div name='Stats' class="d-none container mt-5 ms-5 col-1 h-25 card-body c-gold border border-warning bg-dark rounded">
        <p name='stat'><span class="text-white-50 ps-4">INT:</span> <span id='stat-INT'>{{ value.INT }}</span> (<span id='stat-INT-mod'>{{ value|getMod:"INT" }}</span>)</p>
        <p name='stat'><span class="text-white-50 ps-4">SIŁ:</span> <span id='stat-SIŁ'>{{ value.SIŁ }}</span> (<span id='stat-SIŁ-mod'>{{ value|getMod:"SIŁ" }}</span>)</p>
        <p name='stat'><span class="text-white-50 ps-4">ZRE:</span> <span id='stat-ZRE'>{{ value.ZRE }}</span> (<span id='stat-ZRE-mod'>{{ value|getMod:"ZRE" }}</span>)</p>
        <p name='stat'><span class="text-white-50 ps-4">CHAR:</span> <span id='stat-CHAR'>{{ value.CHAR }}</span> (<span id='stat-CHAR-mod'>{{ value|getMod:"CHAR" }}</span>)</p>
        <p name='stat'><span class="text-white-50 ps-4">CEL:</span> <span id='stat-CEL'>{{ value.CEL }}</span> (<span id='stat-CEL-mod'>{{ value|getMod:"CEL" }}</span>)</p>
    </div>

        <div name='Equipment' class="container col-3 mt-1 ms-2 card-body c-gold border border-warning bg-dark rounded">
            <p class="text-center fw-bold">{{ value.name }}</p>
            <p title='{{ race_desc }}'><span class="text-white-50 ps-4">Race:</span> {{ value.race }} ({{ value.size }})</p>
            <p><span class="text-white-50 ps-4">Health:</span> {{ value.HP }}/{{ value.fullHP }}</p>
            <p><span class="text-white-50 ps-4">Helmet:</span> <a class='c-gold' href=''>{{ value.Helmet }}</a></p>
            <p><span class="text-white-50 ps-4">Torso:</span> <a class='c-gold'  href=''>{{ value.Torso }}</a></p>
            <p><span class="text-white-50 ps-4">Gloves:</span> <a class='c-gold'  href=''>{{ value.Gloves }}</a></p>
            <p><span class="text-white-50 ps-4">Boots:</span> <a class='c-gold'  href=''>{{ value.Boots }}</a></p>

            <p name="LeftHand">
            <span class="text-white-50 ps-4">LeftHand:</span> (<span id='l_bonus'>{{ value.name|isPreffereOrUnliked:value.LeftHand }}</span>)
            {% if value.LeftHand|isNotEmpty %} 
            <a class='c-gold'  href=''><span name="{{ value.LeftHand|getItemType }}" id='l_weapon'>{{ value.LeftHand }}</span>
                {% if value.LeftHand|isShield %}
                [<span id='l_block'>{{ value.LeftHand|getItemBlock }}</span>]
                {% else %}
                [1K<span id='l_dmg'>{{ value.LeftHand|getItemBonus }}</span>, <span id='l_ap'>{{ value.LeftHand|getItemAP }}</span>AP]
                {% endif %}
            {% endif %}
            </a>
            </p>

            {% if value.LeftHand|isDualHanded %}
                <p><span class="text-white-50 ps-4">RightHand:</span> <span id='r_weapon' class='c-gold'>Above weapon is two-handed</span></p>
            {% else %}
            <p name="RightHand">
                <span class="text-white-50 ps-4">RightHand:</span> (<span id='r_bonus'>{{ value.name|isPreffereOrUnliked:value.RightHand }}</span>)
                {% if value.RightHand|isNotEmpty %} 
                <a class='c-gold'  href=''><span name="{{ value.RightHand|getItemType }}" id='r_weapon'>{{ value.RightHand }}</span>
                    {% if value.RightHand|isShield %}
                    [<span id='r_block'>{{ value.RightHand|getItemBlock }}</span>]
                    {% else %}
                    [1K<span id='r_dmg'>{{ value.RightHand|getItemBonus }}</span>, <span id='r_ap'>{{ value.RightHand|getItemAP }}</span>AP]
                    {% endif %}
                {% endif %}
                </a>
                </p>
            
                {% endif %}
            <p><span class="text-white-50 ps-4">Side:</span> <a class='c-gold'  href=''>{{ value.Side }} [{{ value.Side|getItemStatByName }}]</a></p>
        </div>

        <div name='Effects' style='width: auto; height:5%;' class="d-none rounded container col card-body c-gold border border-warning bg-dark m-2">
            <p class="text-center fw-bold">Effects: </p>
            <ul>
            {% for effect in value|getCharacterEffects %}
            <li onclick="show_or_hideById(this.attributes['name'].value)" name='ef{{ effect.id }}' class='fw-bold fst-italic'>{{ effect.name }} (+{{ effect.bonus }}) | Time left: {{ effect.time }}</li>
            <p id='ef{{ effect.id }}' class='d-none'>{{ effect.name|getEffectDesc }}</p>
            {% endfor %}
            </ul>
        </div>
    {% endfor %}

    <div name='Skills' style='width: auto; height:5%;' class="d-none rounded container col card-body c-gold border border-warning bg-dark m-2">
        <p class="text-center fw-bold">Skills: </p>
        <ul class='ms-4'>
        {% for skill in skills %}
            <li>
                <a class='c-gold fst-italic' href='/dunnorpg/skills/{{ skill.original_id }}'>{{ skill.skill }} [{{ skill.level }}]</a>
                <button onclick="show_block(this)" name="{{ skill.id }}" type='button' class='fst-italic ms-2 rounded-circle border border-warning btn btn-sm btn-warning btn-outline-dark c-gold'>i</button>
            </li><br>
        {% endfor %}
        <ul>
    </div>
    {% for skill in skills %}
        <div id='{{ skill.id }}' name="desc_block" style='width: 22%; height:5%;' class="d-none rounded container col-3 card-body c-gold border border-warning bg-dark m-2">
            <p class='fw-bold text-center'>{{ skill.skill }} lvl.{{ skill.level }}</p>
            {{ skill.desc }}
            <br>
            [<span class='fst-italic'>{{ skill.level_desc }}</span>]
        </div>
    {% endfor %}
</div>

<div class='container ms-5 row mt-2'>
    <div onclick="calculate('parry')" class='col btn btn-dark btn-outline-warning border border-warning rounded ms-5 me-5'>
        <span class=''>Parry</span>
    </div>
    <div onclick="calculate('attack')" class='col btn btn-dark btn-outline-warning border border-warning rounded ms-5 me-5'>
        <span class=''>Basic Attack</span>
    </div>
    <div onclick="calculate('dodge')" class='col btn btn-dark btn-outline-warning border border-warning rounded  ms-5 me-5'>
        <span class=''>Dodge</span>
    </div>
    <div onclick="calculate('dice')" class='col btn btn-dark btn-outline-warning border border-warning rounded  ms-5 me-5'>
        <span class=''>Roll dice</span>
    </div>
</div>

<div class='container ms-5 row mt-2'>
    <div class='col card-body c-gold border border-warning bg-dark rounded'>
        <p id='calc_dice'></p>
        <p id='calc_left'></p>
        <p id='calc_right'></p>
    </div>
</div>

<script>
document.getElementById('tb-characters').classList.remove('btn-outline-warning')
document.getElementById('tb-characters').classList.add('btn-outline-primary')
function getRandomInt(min=1,max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min) + min);
    }

function show_block(instance){
    let blocks = document.getElementsByName('desc_block')
    for (let i = 0; i < blocks.length; i++){
            if(blocks[i].id==instance.name){
                if(blocks[i].classList.contains('d-none')){
                    blocks[i].classList.remove('d-none')
                }
                else{
                    blocks[i].classList.add('d-none')
                }
            }
            else{
                blocks[i].classList.add('d-none')
            }
        }
    };

function show_or_hideByName(instance, changeColor=false){
    let element = document.getElementsByName(instance.id)[0]
    if (element.classList.contains('d-none')){
        element.classList.remove('d-none')

        instance.classList.remove('btn-outline-warning')
        instance.classList.remove('border-warning')

        instance.classList.add('btn-outline-primary')
        instance.classList.add('border-primary')
    }
    else{
        element.classList.add('d-none')

        instance.classList.remove('btn-outline-primary')
        instance.classList.remove('border-primary')

        instance.classList.add('btn-outline-warning')
        instance.classList.add('border-warning')
    }
};

function show_or_hideById(id){
    let element = document.getElementById(id)
    if (element.classList.contains('d-none')){
        element.classList.remove('d-none')
    }
    else{
        element.classList.add('d-none')
    }
};

function calculate(action){
    left = document.getElementById('calc_left')
    right = document.getElementById('calc_right')
    dice = document.getElementById('calc_dice')
    if(action=='attack' || action=='parry')
    {
        if(action=='attack'){ //accuraccy
            cel = parseInt(document.getElementById('stat-CEL').innerHTML)
            cel_mod = parseInt(document.getElementById('stat-CEL-mod').innerHTML)
            cel_mods = cel+cel_mod

            dice.innerHTML = '<b>Accuracy: </b>'+
            'CEL'+'('+cel+')'+ ' + '+
            'MODS'+'('+cel_mod+') = '+
            "<span onclick='getDiceWMods(this,cel_mods)'><u>Check</u></span>"
        }

        sil = parseInt(document.getElementById('stat-SIŁ').innerHTML)
        sil_mod = parseInt(document.getElementById('stat-SIŁ-mod').innerHTML)

        if(document.getElementById('l_bonus').innerHTML != 'Empty')
        {
            leftWeapon = document.getElementById('l_weapon')
            l_bonus = parseInt(document.getElementById('l_bonus').innerHTML)
            if(leftWeapon.getAttribute("name") == 'shield'){
                if(action=='parry'){
                    l_block = parseInt(document.getElementById('l_block').innerHTML)
                    left.innerHTML = '<b>Left hand | '+action+': </b>'+
                    'BLOCK'+'('+l_block+')'+ ' + '+
                    'BONUS'+'('+l_bonus+') = '+
                    (l_block+l_bonus)
                }
                else if(action=='attack'){
                    shield_attack_mods = sil-10
                    left.innerHTML = '<b>Left hand | '+action+': </b>'+
                    'SIŁ'+'('+sil+')'+ ' + '+
                    'MODS'+'('+sil_mod+')'+' + '+
                    'BONUS'+'('+l_bonus+')'+' + '+
                    'BASIC(-10) = '+
                    "<span onclick='getDiceWMods(this,shield_attack_mods)'><u>Check</u></span>" 
                }
            }
            else{
                leftWeaponDmg = parseInt(document.getElementById('l_dmg').innerHTML)
                leftWeaponAp = parseInt(document.getElementById('l_ap').innerHTML)
                l_mods = sil+sil_mod+leftWeaponDmg+l_bonus
                left.innerHTML = '<b>Left hand | '+action+': </b>'+
                'SIŁ'+'('+sil+')'+ ' + '+
                'MODS'+'('+sil_mod+')'+' + '+
                'WEAPON'+'('+leftWeaponDmg+')'+' + '+
                'BONUS'+'('+l_bonus+')'+' & '+
                'AP'+'('+leftWeaponAp+') = '+
                "<span onclick='getDiceWMods(this,l_mods)'><u>Check</u></span>"                
            }
        }

        rightOperative = false
        rightWeapon = document.getElementById('r_weapon')
        if(rightWeapon.innerHTML!='Above weapon is two-handed')
        {
            rightOperative=true
        }

        if(rightOperative){
            r_bonus = parseInt(document.getElementById('r_bonus').innerHTML)
            if(document.getElementById('r_bonus').innerHTML != 'Empty')
            {
                rightWeapon = document.getElementById('r_weapon')
                if(rightWeapon.getAttribute("name") == 'shield'){
                    if(action=='parry'){
                        r_block = parseInt(document.getElementById('r_block').innerHTML)
                        right.innerHTML = '<b>Right hand | '+action+': </b>'+
                        'BLOCK'+'('+r_block+')'+ ' + '+
                        'BONUS'+'('+r_bonus+') = '+
                        (r_block+r_bonus)
                    }
                    else if(action=='attack'){
                        shield_attack_mods = sil-10
                        right.innerHTML = '<b>Right hand | '+action+': </b>'+
                        'SIŁ'+'('+sil+')'+ ' + '+
                        'MODS'+'('+sil_mod+')'+' + '+
                        'BONUS'+'('+r_bonus+')'+' + '+
                        'BASIC(-10) = '+
                        "<span onclick='getDiceWMods(this,shield_attack_mods)'><u>Check</u></span>" 
                    }
                }
                else{
                    rightWeaponDmg = parseInt(document.getElementById('r_dmg').innerHTML)
                    rightWeaponAp = parseInt(document.getElementById('r_ap').innerHTML)
                    r_mods = sil+sil_mod+rightWeaponDmg+r_bonus
                    right.innerHTML = '<b>Right hand | '+action+': </b>'+
                    'SIŁ'+'('+sil+')'+ ' + '+
                    'MODS'+'('+sil_mod+')'+' + '+
                    'WEAPON'+'('+rightWeaponDmg+')'+' + '+
                    'BONUS'+'('+r_bonus+')'+' & '+
                    'AP'+'('+rightWeaponAp+') = '+
                    "<span onclick='getDiceWMods(this,r_mods)'><u>Check</u></span>"                
                }
            }
        }
    }
    else if(action=='dodge'){
        right.innerHTML = ""

        zre = parseInt(document.getElementById('stat-ZRE').innerHTML)
        zre_mod = parseInt(document.getElementById('stat-ZRE-mod').innerHTML) 
        dodge_mods = zre+zre_mod

        left.innerHTML="<b>Dodge:</b> "+
        "ZRE"+'('+zre+')'+' + '+
        "MODS"+'('+zre_mod+') = '+
        "<span onclick='getDiceWMods(this,dodge_mods)'><u>Check</u></span>"
    }
    else if(action=='dice'){
        diceRoll = getRandomInt(1,21)
        dice.innerHTML = "<span onclick="+"this.innerHTML=''"+"><b>Dice:</b> " + diceRoll+" (Click to hide)"+"</span>"
    }
}
function getDiceWMods(instance,modsPoints){
    dice = getRandomInt(1,21)
    result = dice+modsPoints
    if(result < 1){
        result = 1
    }
    instance.innerHTML = 'Result: ' + result + ' (Dice ' + dice + ')'
}
</script>

{% endblock content %}